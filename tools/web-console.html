<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OwnWorld Commander v3 (Faction Era)</title>
    <style>
        :root { --bg:#050510; --panel:#151520; --accent:#00d2ff; --warn:#ffae00; --danger:#ff3333; --success:#00ff9d; --text:#ddd; }
        body { background:var(--bg); color:var(--text); font-family:monospace; margin:0; padding:20px; }
        
        /* Layout */
        .grid { display:grid; grid-template-columns: 1fr 350px; gap:20px; }
        .panel { background:var(--panel); border:1px solid #333; padding:15px; margin-bottom:15px; }
        
        /* Controls */
        button { background:transparent; border:1px solid var(--accent); color:var(--accent); padding:5px 10px; cursor:pointer; margin:2px; font-family:inherit; transition:0.2s; }
        button:hover { background:var(--accent); color:#000; }
        button:disabled { border-color:#555; color:#555; cursor:wait; }
        input, select { background:#000; color:#fff; border:1px solid #555; padding:8px; margin-bottom:10px; width:100%; box-sizing:border-box; }

        /* Tabs */
        .tab-bar { margin-bottom:15px; border-bottom:1px solid #444; }
        .tab { padding:10px; border:none; background:none; color:#666; cursor:pointer; font-size:1.1em; }
        .tab.active { color:var(--accent); border-bottom:2px solid var(--accent); }

        /* Resources Grid */
        .res-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin:10px 0; text-align:center; font-size:0.85em; }
        .res-box { background:#222; padding:5px; border-bottom:2px solid #555; position:relative; }
        
        /* Auth Modal */
        #auth-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:flex; justify-content:center; align-items:center; }
        .auth-box { background:var(--panel); border:1px solid var(--accent); padding:30px; width:320px; text-align:center; }
        
        .auth-tabs { display:flex; margin-bottom:20px; border-bottom:1px solid #333; }
        .auth-tab-btn { flex:1; padding:10px; cursor:pointer; background:none; border:none; color:#666; font-weight:bold; }
        .auth-tab-btn.active { color:var(--accent); border-bottom:2px solid var(--accent); }
        
        .fleet-card { border: 1px solid #444; padding: 10px; margin-bottom: 5px; background: #1a1a25; }
        .module-tag { display: inline-block; background: #333; padding: 2px 5px; font-size: 0.8em; margin-right: 3px; border-radius: 3px; }
    </style>
</head>
<body>

<!-- AUTH OVERLAY -->
<div id="auth-overlay">
    <div class="auth-box">
        <h2 style="color:var(--accent); margin-top:0;">OWNWORLD UPLINK</h2>
        
        <input id="srv-url" value="http://localhost:8080" placeholder="Server URL" style="margin-bottom:20px;">

        <div class="auth-tabs">
            <button id="tab-login" class="auth-tab-btn active" onclick="switchAuth('login')" style="border:none;">LOGIN</button>
            <button id="tab-register" class="auth-tab-btn" onclick="switchAuth('register')" style="border:none;">REGISTER</button>
        </div>

        <input id="login-user" placeholder="Username (Alphanumeric)">
        <input id="login-pass" type="password" placeholder="Password">
        
        <button id="auth-btn" onclick="performAuth()" style="width:100%; padding:10px; font-weight:bold; margin-top:10px; background:var(--success); color:#000;">LOGIN</button>
        <div id="auth-msg" style="color:var(--danger); margin-top:10px; font-size:0.9em;"></div>
    </div>
</div>

<!-- MAIN UI -->
<div id="app-ui" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div>
            <strong style="font-size:1.2em; color:var(--accent)">COMMANDER <span id="display-user">...</span></strong>
            <span style="color:#666; margin-left:10px;" id="display-id">ID: ...</span>
        </div>
        <div>
            TICK: <span id="srv-tick" style="color:var(--warn)">...</span>
            LEADER: <span id="srv-leader" style="color:var(--success)">...</span>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab active" onclick="setTab('colonies')">COLONIES</button>
        <button class="tab" onclick="setTab('fleets')">FLEETS (MODULAR)</button>
        <button class="tab" onclick="setTab('construction')">SHIPYARD</button>
        <button class="tab" onclick="setTab('scan')">SCANNER</button>
    </div>

    <div class="grid">
        <!-- Main View -->
        <div id="main-view">
            <div style="color:#666; text-align:center; padding:50px;">Waiting for Uplink...</div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="panel">
                <h3 style="margin-top:0; color:var(--warn)">QUICK ACTIONS</h3>
                <input id="action-amt" type="number" value="1" placeholder="Amount">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                    <button onclick="quickBuild('farm')">Build Farm</button>
                    <button onclick="quickBuild('well')">Build Well</button>
                    <button onclick="quickBuild('iron_mine')">Iron Mine</button>
                    <button onclick="quickBuild('urban_housing')">Housing</button>
                </div>
                <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                    <button style="width:100%; border-color:var(--success); color:var(--success)" onclick="quickBurn('iron')">BURN IRON (Sell)</button>
                </div>
            </div>
            
            <div class="panel">
                <h3 style="margin-top:0;">SYSTEM LOG</h3>
                <div id="logs" style="height:150px; overflow-y:auto; font-size:0.8em; color:#888;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let API_URL = "http://localhost:8080";
    let STATE = null;
    let USER_ID = null;
    let USER_NAME = null;
    let SESSION_TOKEN = null;
    let AUTH_MODE = 'login';
    let ACTIVE_TAB = 'colonies';

    // Shipyard State
    let SELECTED_HULL = 'Fighter';
    let SELECTED_MODULES = [];

    window.onload = function() {
        const saved = localStorage.getItem("ownworld_url");
        if(saved) document.getElementById('srv-url').value = saved;
    }

    function switchAuth(mode) {
        AUTH_MODE = mode;
        document.getElementById('tab-login').className = mode === 'login' ? 'auth-tab-btn active' : 'auth-tab-btn';
        document.getElementById('tab-register').className = mode === 'register' ? 'auth-tab-btn active' : 'auth-tab-btn';
        document.getElementById('auth-btn').innerText = mode.toUpperCase();
        document.getElementById('auth-msg').innerText = "";
    }

    async function performAuth() {
        const url = document.getElementById('srv-url').value.replace(/\/$/, "");
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        
        if(!u || !p) return showAuthError("Credentials missing");
        
        localStorage.setItem("ownworld_url", url);
        API_URL = url + "/api";
        showAuthError("Connecting...", "var(--accent)");

        try {
            const res = await fetch(`${API_URL}/register`, {
                method: 'POST', body: JSON.stringify({username: u, password: p})
            });

            if(res.ok) {
                const data = await res.json();
                USER_ID = data.user_uuid;
                USER_NAME = u;
                SESSION_TOKEN = data.session_token; 
                startSession();
            } else {
                const txt = await res.text();
                showAuthError("Error: " + txt);
            }
        } catch(e) {
            showAuthError("Connection Failed");
        }
    }

    function startSession() {
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('app-ui').style.display = 'block';
        document.getElementById('display-user').innerText = USER_NAME;
        document.getElementById('display-id').innerText = `ID: ${USER_ID.substring(0,8)}...`;
        refreshState();
        setInterval(refreshState, 2000); 
    }

    function showAuthError(msg, color="var(--danger)") {
        const el = document.getElementById('auth-msg');
        el.style.color = color;
        el.innerText = msg;
    }

    async function refreshState() {
        if(!USER_ID) return;
        try {
            const sRes = await fetch(`${API_URL}/status`);
            const sData = await sRes.json();
            document.getElementById('srv-tick').innerText = sData.tick;
            document.getElementById('srv-leader').innerText = sData.leader ? sData.leader.substring(0,8) : "???";

            const res = await fetch(`${API_URL}/state`, {
                headers: {
                    'X-User-UUID': USER_ID,
                    'X-Session-Token': SESSION_TOKEN
                }
            });
            if(res.ok) {
                STATE = await res.json();
                renderMain();
            }
        } catch(e) {}
    }

    function escapeHTML(str) {
        return str.replace(/[&<>'"]/g, 
            tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag]));
    }

    function renderMain() {
        const v = document.getElementById('main-view');
        if (!STATE) return;

        if (ACTIVE_TAB === 'colonies') {
            if (!STATE.MyColonies || STATE.MyColonies.length === 0) {
                v.innerHTML = "<div class='panel'>No Colonies Found.</div>";
                return;
            }
            v.innerHTML = STATE.MyColonies.map(c => {
                const pop = c.pop_laborers + (c.pop_specialists||0);
                return `
                <div class="panel" style="border-left: 4px solid var(--accent)">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
                        <strong style="font-size:1.2em;">${escapeHTML(c.name)}</strong>
                        <span>SYS: ${c.system_id || "Unknown"}</span>
                    </div>
                    <div class="res-grid">
                        ${renderResBox('IRON', c.iron)}
                        ${renderResBox('CARB', c.carbon)}
                        ${renderResBox('H2O', c.water)}
                        ${renderResBox('FOOD', c.vegetation)}
                    </div>
                    <div style="background:#111; padding:10px; font-size:0.9em; color:#888; margin-top:10px;">
                        POP: ${pop} | STABILITY: ${Math.floor(c.stability_current)}%
                    </div>
                </div>`;
            }).join('');
        } else if (ACTIVE_TAB === 'fleets') {
             if (!STATE.MyFleets || STATE.MyFleets.length === 0) {
                v.innerHTML = "<div class='panel'>No Fleets. Build them in Shipyard.</div>";
                return;
            }
            v.innerHTML = STATE.MyFleets.map(f => `
                <div class="fleet-card">
                    <div style="color:var(--accent); font-weight:bold;">${f.hull_class ? f.hull_class.toUpperCase() : 'UNKNOWN'} - ID: ${f.id}</div>
                    <div style="color:#888; font-size:0.9em; margin:5px 0;">Status: ${f.status} | System: ${f.dest_system || f.origin_system}</div>
                    <div>
                        ${f.modules ? f.modules.map(m => `<span class="module-tag">${m}</span>`).join('') : ''}
                    </div>
                    <div style="margin-top:10px;">
                        <button onclick="launchFleet(${f.id})">LAUNCH</button>
                    </div>
                </div>
            `).join('');
        } else if (ACTIVE_TAB === 'construction') {
            v.innerHTML = `
                <div class="panel">
                    <h3>SHIP DESIGNER</h3>
                    <label>Hull Class:</label>
                    <select id="hull-select" onchange="SELECTED_HULL=this.value; SELECTED_MODULES=[]; renderMain()">
                        <option value="Fighter" ${SELECTED_HULL==='Fighter'?'selected':''}>Fighter (1 Eng, 4 Wpn)</option>
                        <option value="SpeedyFighter" ${SELECTED_HULL==='SpeedyFighter'?'selected':''}>Speedy Fighter (2 Eng, 2 Wpn)</option>
                        <option value="Bomber" ${SELECTED_HULL==='Bomber'?'selected':''}>Bomber (1 Eng, 1 Spec[Bomb])</option>
                        <option value="Frigate" ${SELECTED_HULL==='Frigate'?'selected':''}>Frigate (4 Eng)</option>
                        <option value="Colonizer" ${SELECTED_HULL==='Colonizer'?'selected':''}>Colonizer (2 Eng, 1 Spec[Ark])</option>
                    </select>
                    
                    <div style="margin-top:10px;">
                        <button onclick="addMod('warp_drive')">+ Warp Drive</button>
                        <button onclick="addMod('laser')">+ Laser</button>
                        <button onclick="addMod('booster')">+ Booster</button>
                        <button onclick="addMod('colony_kit')">+ Colony Kit</button>
                        <button onclick="addMod('bomb_bay')">+ Bomb Bay</button>
                        <button onclick="SELECTED_MODULES=[]; renderMain()" style="color:var(--danger); border-color:var(--danger)">CLEAR</button>
                    </div>
                    
                    <div style="margin:15px 0; border:1px dashed #555; padding:10px;">
                        <strong>Current Configuration:</strong>
                        <div>${SELECTED_MODULES.join(', ') || 'Empty'}</div>
                    </div>
                    
                    <button style="width:100%; background:var(--success); color:black;" onclick="constructShip()">CONSTRUCT SHIP</button>
                </div>
            `;
        } else if (ACTIVE_TAB === 'scan') {
            v.innerHTML = `
                <div class="panel">
                    <h3>SECTOR SCANNER</h3>
                    <p>Enter coordinates to probe the Universal Hash Field.</p>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input id="scan-x" type="number" placeholder="X">
                        <input id="scan-y" type="number" placeholder="Y">
                        <input id="scan-z" type="number" placeholder="Z">
                    </div>
                    <button onclick="scanSector()" style="width:100%; border-color:var(--accent); color:var(--accent);">SCAN SECTOR</button>
                    <div id="scan-results" style="margin-top:20px; font-family:monospace;"></div>
                </div>
            `;
        }
    }

    function addMod(m) {
        SELECTED_MODULES.push(m);
        renderMain();
    }

    async function constructShip() {
        if(!STATE || !STATE.MyColonies[0]) return log("No Colony to build at.");
        
        apiCall('construct', {
            colony_id: STATE.MyColonies[0].id,
            hull_class: SELECTED_HULL,
            modules: SELECTED_MODULES,
            amount: 1
        }, "Ship Construction Started");
    }

    function renderResBox(label, val) {
        return `<div class="res-box"><div style="color:#888; font-size:0.8em">${label}</div><div style="font-size:1.1em; color:#fff">${val}</div></div>`;
    }

    function setTab(t) {
        ACTIVE_TAB = t;
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        renderMain();
    }

    async function quickBuild(struct) {
        if(!STATE || !STATE.MyColonies[0]) return log("No colony selected.");
        const colId = STATE.MyColonies[0].id;
        const amt = parseInt(document.getElementById('action-amt').value) || 1;
        apiCall('build', {colony_id: colId, structure: struct, amount: amt}, "Construction Started");
    }

    async function quickBurn(item) {
        if(!STATE || !STATE.MyColonies[0]) return;
        const colId = STATE.MyColonies[0].id;
        const amt = parseInt(document.getElementById('action-amt').value) || 100;
        apiCall('bank/burn', {colony_id: colId, item: item, amount: amt, user_id: 0}, "Resources Sold");
    }
    
    async function launchFleet(id) {
        const dest = prompt("Enter Target System ID (e.g. sys-100-50-20):");
        if(dest) {
            apiCall('fleet/launch', {fleet_id: id, target_system: dest}, "Launch Sequence Initiated");
        }
    }

    async function scanSector() {
        const x = parseInt(document.getElementById('scan-x').value);
        const y = parseInt(document.getElementById('scan-y').value);
        const z = parseInt(document.getElementById('scan-z').value);
        
        if (isNaN(x) || isNaN(y) || isNaN(z)) return log("Invalid Coords");

        try {
            const res = await fetch(`${API_URL}/scan`, {
                method: 'POST', 
                body: JSON.stringify({x: x, y: y, z: z}),
                headers: {
                    'X-User-UUID': USER_ID,
                    'X-Session-Token': SESSION_TOKEN
                }
            });
            const data = await res.json();
            const el = document.getElementById('scan-results');
            
            if (data.has_system) {
                el.innerHTML = `
                    <div style="color:var(--success)">SIGNAL DETECTED!</div>
                    <div>Type: ${data.system_type}</div>
                    <div>Resources:</div>
                    <ul style="font-size:0.9em; color:#ccc;">
                        ${Object.entries(data.resources).map(([k,v]) => `<li>${k}: ${v.toFixed(2)}</li>`).join('')}
                    </ul>
                    <div style="color:var(--warn)">Hazards: ${(data.hazards * 100).toFixed(1)}%</div>
                `;
            } else {
                el.innerHTML = "<div style='color:#666'>Void sector. No gravity well.</div>";
            }
        } catch(e) {
            log("Scan Failed");
        }
    }

    async function apiCall(endpoint, payload, successMsg) {
        try {
            const res = await fetch(`${API_URL}/${endpoint}`, {
                method: 'POST', 
                body: JSON.stringify(payload),
                headers: {
                    'X-User-UUID': USER_ID,
                    'X-Session-Token': SESSION_TOKEN
                }
            });
            if(res.ok) { log(successMsg); refreshState(); }
            else { log("Error: " + await res.text()); }
        } catch(e) { log("Network Error"); }
    }

    function log(msg) {
        const l = document.getElementById('logs');
        l.innerHTML = `<div>> ${msg}</div>` + l.innerHTML;
    }
</script>

</body>
</html>
